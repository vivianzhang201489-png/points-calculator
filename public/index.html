<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>订单积分工具（内部使用）</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 24px;
        background: #fafafa;
        color: #222;
      }

      h1 {
        font-size: 26px;
        margin: 0 0 12px;
      }

      .page-subtitle {
        font-size: 14px;
        color: #666;
        margin-bottom: 24px;
      }

      .top-bar {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        margin-bottom: 16px;
        gap: 12px;
      }

      .btn-primary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 22px;
        border-radius: 999px;
        border: none;
        background: #ff0b75;
        color: #fff;
        font-size: 14px;
        font-weight: 600;
        letter-spacing: 0.05em;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(255, 11, 117, 0.3);
        transition:
          transform 0.08s ease-out,
          box-shadow 0.1s ease-out,
          background 0.1s ease-out,
          opacity 0.1s ease-out;
        user-select: none;
      }

      .btn-primary:hover:not(:disabled) {
        background: #ff2c8b;
        box-shadow: 0 6px 14px rgba(255, 11, 117, 0.4);
        transform: translateY(-1px);
      }

      .btn-primary:active:not(:disabled) {
        transform: translateY(1px) scale(0.98);
        box-shadow: 0 2px 6px rgba(255, 11, 117, 0.25);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
        transform: none;
      }

      .layout {
        max-width: 900px;
        margin: 0 auto;
      }

      .card {
        background: #ffffff;
        border-radius: 8px;
        padding: 18px 18px 20px;
        margin-bottom: 18px;
        box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
      }

      .card-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 12px;
      }

      .divider {
        height: 3px;
        background: linear-gradient(90deg, #ff0b75, #ff6fb5 60%, transparent);
        border-radius: 999px;
        margin: 4px 0 12px;
      }

      textarea {
        width: 100%;
        min-height: 180px;
        resize: vertical;
        padding: 10px;
        font-size: 14px;
        line-height: 1.5;
        border-radius: 4px;
        border: 1px solid #ddd;
        font-family: inherit;
      }

      textarea::placeholder {
        color: #b3b3b3;
      }

      textarea:focus {
        outline: none;
        border-color: #ff0b75;
        box-shadow: 0 0 0 1px rgba(255, 11, 117, 0.3);
      }

      .field-group {
        margin-bottom: 10px;
      }

      .field-label {
        font-size: 14px;
        margin-bottom: 4px;
        display: block;
      }

      input[type="number"] {
        width: 100%;
        padding: 8px 10px;
        font-size: 14px;
        border-radius: 4px;
        border: 1px solid #ddd;
      }

      input[type="number"]::placeholder {
        color: #b3b3b3;
      }

      input[type="number"]:focus {
        outline: none;
        border-color: #ff0b75;
        box-shadow: 0 0 0 1px rgba(255, 11, 117, 0.3);
      }

      /* 去掉数字输入的上下小箭头 */
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }

      .points-row {
        font-size: 16px;
        margin-top: 8px;
      }

      .points-value {
        font-weight: 700;
        color: #ff0b75;
        margin-left: 4px;
      }

      @media (max-width: 600px) {
        body {
          padding: 16px;
        }
        h1 {
          font-size: 22px;
        }
        .card {
          padding: 14px 12px 16px;
        }
      }
    </style>
  </head>

  <body>
    <div class="layout">
      <h1>订单积分工具（内部使用）</h1>
      <div class="page-subtitle">
        上方按钮<strong>手动保存记录</strong>，数据写入数据库；刷新页面会自动从数据库读取最近一次记录。
      </div>

      <div class="top-bar">
        <button id="save-btn" class="btn-primary">手动保存记录</button>
      </div>

      <!-- 问题订单记录 -->
      <div class="card">
        <div class="card-title">问题订单记录</div>
        <div class="divider"></div>
        <textarea
          id="issue-log"
          placeholder="在这里记录有问题的订单、备注等，例如：&#10;2025xxxx 订单号 xxx，说明……"
        ></textarea>
      </div>

      <!-- 积分计算器 -->
      <div class="card">
        <div class="card-title">积分计算器</div>
        <div class="divider"></div>

        <div class="field-group">
          <label class="field-label" for="subtotal">Subtotal（小计）</label>
          <input
            id="subtotal"
            type="number"
            placeholder="例如：100.00"
            inputmode="decimal"
          />
        </div>

        <div class="field-group">
          <label class="field-label" for="discount">Discount（折扣）</label>
          <input
            id="discount"
            type="number"
            placeholder="例如：10.00"
            inputmode="decimal"
          />
        </div>

        <div class="field-group">
          <label class="field-label" for="points-paid">
            Points Paid（积分支付金额）<span
              style="color: #666; font-weight: 400"
              >（没用积分可留空）</span
            >
          </label>
          <input
            id="points-paid"
            type="number"
            placeholder="例如：45.00"
            inputmode="decimal"
          />
        </div>

        <div class="field-group">
          <label class="field-label" for="cash-paid">
            Cash Paid（现金支付金额）<span style="color: #666; font-weight: 400"
              >（如填写积分支付，此项必填）</span
            >
          </label>
          <input
            id="cash-paid"
            type="number"
            placeholder="例如：45.00"
            inputmode="decimal"
          />
        </div>

        <div class="points-row" style="margin-top: 10px">
          积分（5%）：
          <span id="points-result" class="points-value">0</span>
        </div>

        <div
          id="points-hint"
          style="margin-top: 6px; font-size: 13px; color: #666"
        ></div>
      </div>

      <!-- 积分发放记录 -->
      <div class="card">
        <div class="card-title">积分发放记录</div>
        <div class="divider"></div>
        <textarea
          id="send-log"
          placeholder="在这里记录积分发放的订单，例如：&#10;2025/12/01 发送给 xxx..."
        ></textarea>
      </div>
    </div>

    <script>
      // ======= 积分计算（更新版：积分支付部分不发积分） =======
      const subtotalInput = document.getElementById("subtotal");
      const discountInput = document.getElementById("discount");
      const pointsPaidInput = document.getElementById("points-paid");
      const cashPaidInput = document.getElementById("cash-paid");

      const pointsSpan = document.getElementById("points-result");
      const pointsHint = document.getElementById("points-hint");

      function n(v) {
        // 空 => 0；非法 => NaN
        if (v === "" || v === null || v === undefined) return 0;
        const num = Number(v);
        return Number.isFinite(num) ? num : NaN;
      }

      function calcPoints() {
        const subtotal = n(subtotalInput.value);
        const discount = n(discountInput.value);
        const pointsPaid = n(pointsPaidInput?.value);
        const cashPaid = n(cashPaidInput?.value);

        // 基础校验
        if (!Number.isFinite(subtotal) || subtotal < 0) {
          pointsSpan.textContent = "0";
          pointsHint.textContent = "Subtotal 请输入有效数字（≥ 0）";
          pointsHint.style.color = "#c0392b";
          return;
        }
        if (!Number.isFinite(discount) || discount < 0) {
          pointsSpan.textContent = "0";
          pointsHint.textContent = "Discount 请输入有效数字（≥ 0）";
          pointsHint.style.color = "#c0392b";
          return;
        }

        const netMerch = Math.max(subtotal - discount, 0); // 只在商品净额上发积分

        // 若没用积分：默认 100% 现金支付
        if (pointsPaid <= 0) {
          const issued = (netMerch * 0.05).toFixed(2);
          pointsSpan.textContent = String(issued);
          pointsHint.textContent = `商品净额 $${netMerch.toFixed(2)}，默认全现金支付（未填写积分支付）`;
          pointsHint.style.color = "#666";
          return;
        }

        // 用了积分：两格都必须填
        if (!Number.isFinite(cashPaid) || cashPaid <= 0) {
          pointsSpan.textContent = "0";
          pointsHint.textContent =
            "如填写了 Points Paid，则 Cash Paid 必须填写且 > 0";
          pointsHint.style.color = "#c0392b";
          return;
        }

        const totalPaid = pointsPaid + cashPaid;
        if (!Number.isFinite(totalPaid) || totalPaid <= 0) {
          pointsSpan.textContent = "0";
          pointsHint.textContent = "Points Paid + Cash Paid 必须 > 0";
          pointsHint.style.color = "#c0392b";
          return;
        }

        const cashRatio = cashPaid / totalPaid;
        const eligibleAmount = netMerch * cashRatio;
        const issued = (eligibleAmount * 0.05).toFixed(2);

        pointsSpan.textContent = String(issued);
        pointsHint.textContent = `商品净额 $${netMerch.toFixed(2)} × 现金比例 ${(cashRatio * 100).toFixed(2)}% = 可发金额 $${eligibleAmount.toFixed(2)}`;
        pointsHint.style.color = "#666";
      }

      ["input",S "change"].forEach((evt) => {
        subtotalInput.addEventListener(evt, calcPoints);
        discountInput.addEventListener(evt, calcPoints);
        pointsPaidInput.addEventListener(evt, calcPoints);
        cashPaidInput.addEventListener(evt, calcPoints);
      });

      // ======= 日志加载 / 保存（手动） =======
      const issueTextarea = document.getElementById("issue-log");
      const sendTextarea = document.getElementById("send-log");
      const saveBtn = document.getElementById("save-btn");

      // 这里只在控制台里打日志，不再在页面上显示绿色文字
      function setStatus(text, type) {
        console.log(`[${type}] ${text}`);
      }

      // 1）页面加载时，从服务器读取最近一条记录
      async function loadLogs() {
        try {
          console.log("调用 /api/logs 读取数据...");
          const res = await fetch("/api/logs");
          console.log("/api/logs 响应状态：", res.status);

          if (!res.ok) throw new Error("响应不是 2xx");

          const json = await res.json();
          console.log("/api/logs 返回数据：", json);

          const payload = json.data;
          if (!payload) {
            setStatus("数据库暂无记录，当前为空。", "success");
            return;
          }

          // 兼容 data 是单个对象 或 数组的情况
          const latest = Array.isArray(payload) ? payload[0] : payload;

          issueTextarea.value = latest?.issue_log ?? "";
          sendTextarea.value = latest?.send_log ?? "";

          setStatus("已从服务器加载最新记录。", "success");
        } catch (err) {
          console.error(err);
          setStatus("加载日志失败，当前显示空白文本。", "error");
        }
      }

      // 2）点击按钮时，把两块内容存到数据库
      async function saveLogsManually() {
        try {
          saveBtn.disabled = true;
          saveBtn.textContent = "保存中...";

          const res = await fetch("/api/logs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              issue_log: issueTextarea.value,
              send_log: sendTextarea.value,
            }),
          });

          if (!res.ok) throw new Error("响应不是 2xx");

          const json = await res.json();
          console.log("/api/logs 保存返回：", json);

          setStatus("已保存到数据库。", "success");
        } catch (err) {
          console.error(err);
          setStatus("保存失败，请稍后重试。", "error");
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = "手动保存记录";
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadLogs(); // 进入页面就先从数据库读一次
        saveBtn.addEventListener("click", saveLogsManually);
      });
    </script>
  </body>
</html>
