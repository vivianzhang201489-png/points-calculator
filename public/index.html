<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>订单积分工具（内部使用）</title>

    <meta name="robots" content="noindex, nofollow" />

    <style>
      /* 移除 number 输入框的上下箭头（spinner） */
      .no-spinner::-webkit-outer-spin-button,
      .no-spinner::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .no-spinner {
        -moz-appearance: textfield; /* Firefox */
        appearance: textfield;
        width: 100%;
        padding: 8px;
        font-size: 14px;
        box-sizing: border-box;
        border-radius: 4px;
        border: 1px solid #ccc;
        margin-top: 4px;
      }

      body {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        max-width: 960px;
        margin: 24px auto;
        padding: 16px;
        line-height: 1.5;
      }

      h1 {
        font-size: 26px;
        margin-bottom: 16px;
        font-weight: 700;
      }

      h2 {
        font-size: 20px;
        margin: 0 0 12px;
        font-weight: 700;
      }

      .section {
        margin-top: 24px;
        padding: 16px;
        border-radius: 6px;
        border: 1px solid #eee;
        background: #fafafa;
      }

      .section-header {
        border-bottom: 3px solid #f0127f;
        padding-bottom: 6px;
        margin-bottom: 12px;
      }

      textarea {
        width: 100%;
        min-height: 180px;
        box-sizing: border-box;
        font-family: monospace;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        resize: vertical;
      }

      .status {
        font-size: 12px;
        margin-top: 4px;
        color: #888;
        min-height: 16px;
      }

      .status--success {
        color: #1b8a1b;
      }

      .status--error {
        color: #c0392b;
      }

      /* 手动保存按钮 */
      .btn-save {
        background: #ff007a;
        color: white;
        padding: 10px 18px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
      }
      .btn-save:hover {
        background: #e0006c;
      }
    </style>
  </head>

  <body>
    <h1>订单积分工具（内部使用）</h1>

    <!-- 手动保存按钮（靠左） -->
    <div style="margin-bottom: 20px">
      <button id="saveAllBtn" class="btn-save">手动保存所有记录</button>
    </div>

    <!-- 问题订单记录 -->
    <div class="section">
      <div class="section-header">
        <h2>问题订单记录（手动保存）</h2>
      </div>

      <textarea
        id="issue-log"
        placeholder="在这里记录有问题的订单、备注等。例如：2025xxxx 订单号 xxx，说明……"
      ></textarea>
      <div id="issue-status" class="status"></div>
    </div>

    <!-- 订单积分计算 -->
    <div class="section">
      <div class="section-header">
        <h2>订单积分计算器（自动计算）</h2>
      </div>

      <label for="subtotal">Subtotal（小计）</label>
      <input type="text" id="subtotal" class="no-spinner" />

      <label for="discount">Discount（折扣）</label>
      <input type="text" id="discount" class="no-spinner" />

      <div class="points-result">
        积分：<span id="points-result">0.00</span>
      </div>
    </div>

    <!-- 发放记录日志 -->
    <div class="section">
      <div class="section-header">
        <h2>发放记录日志（手动保存）</h2>
      </div>

      <textarea
        id="send-log"
        placeholder="记录已发放积分的订单号、金额、时间等……"
      ></textarea>
      <div id="send-status" class="status"></div>
    </div>

    <script>
      // ===========================================================
      // 积分自动计算
      // ===========================================================
      const subtotalInput = document.getElementById("subtotal");
      const discountInput = document.getElementById("discount");
      const pointsSpan = document.getElementById("points-result");

      function calcPoints() {
        const subtotal = parseFloat(subtotalInput.value) || 0;
        const discount = parseFloat(discountInput.value) || 0;
        const base = Math.max(subtotal - discount, 0);

        const points = base * 0.05; // 5%
        pointsSpan.textContent = points.toFixed(2);
      }

      subtotalInput.addEventListener("input", calcPoints);
      discountInput.addEventListener("input", calcPoints);

      // ===========================================================
      // 从数据库加载
      // ===========================================================
      async function loadLogs() {
        try {
          const res = await fetch("/api/load");
          const data = await res.json();

          document.getElementById("issue-log").value = data.issue_log || "";
          document.getElementById("send-log").value = data.send_log || "";

          document.getElementById("issue-status").textContent = "加载成功";
          document
            .getElementById("issue-status")
            .classList.add("status--success");
        } catch (err) {
          console.error(err);
          document.getElementById("issue-status").textContent = "加载日志失败";
          document
            .getElementById("issue-status")
            .classList.add("status--error");
        }
      }

      // ===========================================================
      // 手动保存按钮
      // ===========================================================
      document
        .getElementById("saveAllBtn")
        .addEventListener("click", async () => {
          const issue_log = document.getElementById("issue-log").value;
          const send_log = document.getElementById("send-log").value;

          try {
            await fetch("/api/save", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ issue_log, send_log }),
            });

            document.getElementById("issue-status").textContent =
              "已保存到数据库 ✔";
            document
              .getElementById("issue-status")
              .classList.add("status--success");
          } catch (err) {
            console.error(err);
            document.getElementById("issue-status").textContent = "保存失败";
            document
              .getElementById("issue-status")
              .classList.add("status--error");
          }
        });

      // 页面加载时从数据库读取
      loadLogs();
    </script>
  </body>
</html>
